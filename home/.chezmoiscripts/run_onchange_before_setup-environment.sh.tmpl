#!/bin/bash

set -e

echo "üöÄ Setting up your development environment..."

# Install Homebrew if not present
if ! command -v brew &> /dev/null; then
    echo "üì¶ Homebrew not found."
    read -p "Would you like to install Homebrew? (y/N): " -n 1 -r
    echo

    if [[ $REPLY =~ ^[Yy]$ ]]; then
        echo "üì¶ Installing Homebrew..."
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

        # Add Homebrew to PATH for Apple Silicon Macs
        if [[ $(uname -m) == "arm64" ]]; then
            echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> ~/.zprofile
            eval "$(/opt/homebrew/bin/brew shellenv)"
        fi
    else
        echo "‚è≠Ô∏è  Skipping Homebrew installation"
    fi
else
    echo "‚úÖ Homebrew is already installed"
fi

# Install packages from Brewfile if it exists (only if Homebrew is available)
if command -v brew &> /dev/null && [ -f "$HOME/.Brewfile" ]; then
    echo "üìã Installing packages from Brewfile..."
    export HOMEBREW_BUNDLE_FILE="$HOME/.Brewfile"
    brew bundle install
elif ! command -v brew &> /dev/null; then
    echo "‚ö†Ô∏è  Homebrew not available, skipping package installation"
else
    echo "‚ö†Ô∏è  No Brewfile found, skipping package installation"
fi

# Configure Touch ID for sudo
if [ ! -f /etc/pam.d/sudo_local ]; then
    echo "üîê Setting up Touch ID for sudo..."
    sudo cp /etc/pam.d/sudo_local.template /etc/pam.d/sudo_local
    echo "auth sufficient pam_tid.so" | sudo tee -a /etc/pam.d/sudo_local
    echo "‚úÖ Touch ID for sudo configured"
elif ! grep -q "pam_tid.so" /etc/pam.d/sudo_local; then
    echo "üîê Adding Touch ID authentication to existing sudo_local..."
    echo "auth sufficient pam_tid.so" | sudo tee -a /etc/pam.d/sudo_local
    echo "‚úÖ Touch ID for sudo configured"
else
    echo "‚úÖ Touch ID for sudo already configured"
fi

echo "‚ú® Setup complete!"
